"use strict";function r(r){return r&&"object"==typeof r&&"default"in r?r.default:r}Object.defineProperty(exports,"__esModule",{value:!0});var e=r(require("p-map")),n=r(require("jsonwebtoken")),t=r(require("express"));function o(){return(o=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(r[t]=n[t])}return r}).apply(this,arguments)}function i(r,e){try{var n=r()}catch(r){return e(r)}return n&&n.then?n.then(void 0,e):n}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var u=["to","cc","bcc"];function c(r){return"string"==typeof r?r:Array.isArray(r)?r.map((function(r){return"string"==typeof r?r:r.address||void 0})).filter((function(r){return Boolean(r)})):(null==r?void 0:r.address)?r.address:void 0}var a=function(r,e){return n.sign(o({},e),r.jwtSecret,{expiresIn:"1y"})},s=function(r,e){try{return n.verify(e,r.jwtSecret)}catch(r){var t=new Error("JwtDecodeError");throw t.name="JwtDecodeError",t}};function f(r){return"JwtDecodeError"===r.name}var l=/(<a\s+(?:[^>]*?\s+)?href=")([^"]*)(")/gi,v=function(r,e,n){return function(r,e,n){return e.replace(l,(function(e,t,i,u){if(i.match(/^#/))return[t,i,u].join("");var c=o({},n,{link:i}),s=a(r,c);return""+t+r.baseUrl+"/link/"+s+u}))}(r,function(r,e,n){var t=a(r,n),o='<img src="'+r.baseUrl+"/blank-image/"+t+'" />';return new RegExp(/<\/body>/).test(e)?e.replace(/<\/body>/,o+"</body>"):""+e+o}(r,e,n),n).trim()};exports.expressApp=function(r){var e=t();return e.get("/link/:jwt",(function(e,n,t){try{var o=i((function(){var t=s(r,e.params.jwt);return Promise.resolve(r.onLinkClick(t)).then((function(){n.redirect(t.link)}))}),(function(r){f(r)?t():t(r)}));return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(r){return Promise.reject(r)}})),e.get("/blank-image/:jwt",(function(e,n,t){try{var o=i((function(){var t=s(r,e.params.jwt);return Promise.resolve(r.onBlankImageView(t)).then((function(){n.set("Content-Type","image/svg+xml"),n.send('<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"/>')}))}),(function(r){f(r)?t():t(r)}));return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(r){return Promise.reject(r)}})),e},exports.sendMail=function(r,n,t){try{var a=function(a){if(s)return a;var f=function(r,e){return function(r){return u.map((function(e){return r[e]})).map((function(e){return function(r,e){var n=e.to,t=e.cc,i=e.bcc,u=function(r,e){if(null==r)return{};var n,t,o={},i=Object.keys(r);for(t=0;t<i.length;t++)e.indexOf(n=i[t])>=0||(o[n]=r[n]);return o}(e,["to","cc","bcc"]),a={},s=c(n);s&&(a.To=s);var f=c(t);f&&(a.Cc=f);var l=c(i);l&&(a.Bcc=l);var v,d=c(u.from);return((void 0===(v=c(r))||Array.isArray(v)?v:[v])||[]).map((function(r){return o({},u,{headers:o({},u.headers,a),envelope:{from:Array.isArray(d)?d[0]:d,to:r}})}))}(e,r)})).flat().filter((function(r){return Boolean(r)}))}(e).map((function(e){var n,t,i={recipient:"object"==typeof e.envelope.to?e.envelope.to.address:(n=e.envelope.to,t=n.match(/([a-zA-Z0-9._-]+[d+1]?[a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi),t&&t[0]||"")},u=o({},r.getData(i),i);return o({},e,{html:v(r,e.html,u)})}))}(r,t);return e(f,(function(e){return Promise.resolve(i((function(){function t(){return Promise.resolve(n.sendMail(e)).then((function(r){return{result:r,sendOptions:e}}))}var o=function(){if(r.getSendOptionsBeforeSend)return Promise.resolve(r.getSendOptionsBeforeSend(e)).then((function(r){e=r}))}();return o&&o.then?o.then(t):t()}),(function(r){return{error:r,sendOptions:e}})))}),{concurrency:r.sendConcurrency||Infinity})},s=!1,f=function(){if(!(r=t).html||"string"!=typeof r.html)return i((function(){return Promise.resolve(n.sendMail(t)).then((function(r){return s=!0,[{result:r,sendOptions:t}]}))}),(function(r){return s=!0,[{error:r,sendOptions:t}]}));var r}();return Promise.resolve(f&&f.then?f.then(a):a(f))}catch(r){return Promise.reject(r)}};
//# sourceMappingURL=nodemailer-mail-tracking.cjs.production.min.js.map
